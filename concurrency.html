<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Concurrency</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">
    
    <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-77665803-1', 'auto');
	  ga('send', 'pageview');

	</script>
  
	<script src="js/jquery-1.11.1.min.js"></script>
  
	<script src="js/shCore.js"></script>

	<script src="js/shBrushScala.js"></script>
	<script src="js/shBrushCSharp.js"></script>
	<script src="js/shBrushDart.js"></script>
	<script src="js/shBrushJava.js"></script>
	<script src="js/shBrushLense.js"></script>

    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <link href="css/base.css" rel="stylesheet">
	<link href="css/asciidoctor.css" rel="stylesheet">
 
  	<link rel="stylesheet" type="text/css" href="css/shCore.css"  >
	<link rel="stylesheet" type="text/css" href="css/shThemeLense.css" >
	<link rel="stylesheet" type="text/css" href="css/shThemeDefault.css" >
	<link rel="stylesheet" type="text/css" href="css/site.css" >

	<style>
		.navbar-toggle{
			float:left;
			margin-left:7px;
		}
		
		code {
			color: #444;
		}
	</style>
	
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->

    <link rel="shortcut icon" href="icon.png">
	
	<script>
	$(document).ready(function() {
	  $(".collapsible-menu").on("click", "li > a", function(e) {
		var p = $(this).parent();
		if (p.hasClass("has-children")) {
			p.toggleClass("open").siblings(".open").removeClass("open");
		}
	  });
	  
	  var url = window.location.pathname;
		var filename = url.substring(url.lastIndexOf('/')+1);
		
	  $(".collapsible-menu a").each(function(){
		var link = $(this).attr("href");
		
		if (filename == link) {
			var item = $(this).parent();
			
			while (!item.hasClass("collapsible-menu")){
				if (item.hasClass("has-children")) {
					item.toggleClass("open").siblings(".open").removeClass("open");
				}
				item = $(item).parent()
			}
		}

	  })
	  
	});
	</script>
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">
	
	<!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top" >
      <div class="container">
        <div class="navbar-header">
		  <button type="button" data-target="#navbar" data-toggle="collapse" class="navbar-toggle"> 
			  <span class="sr-only">Toggle navigation</span> 
			  <span class="icon-bar"></span> 
			  <span class="icon-bar"></span> 
		  </button>
          <a class="navbar-brand" href="index.html">Lense</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Get Started<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li class="disabled"><a href="learn.html">Learn Lense</a></li>
					<li class="disabled"><a href="try.html">Try Lense</a></li>
					<li><a href="https://github.com/sergiotaborda/lense-lang">Download</a></li>
				</ul>
			</li>
            <li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Fundamentals<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li><a href="tour/tour.html">Language Tour</a></li>
					<li class="disabled"><a href="guide.html">Programmer's Guide</a></li>
					<li><a href="platforms.html">Target Platforms's Guide</a></li>
						<li><a href="glossary.html">Glossary</a></li>
				</ul>
            </li>
			
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Details<b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li><a href="nullability.html">Nullability</a></li>
					<li><a href="mutability.html">Immutability</a></li>
					<li><a href="numbers.html">Numbers</a></li>
					<li><a href="strings.html">Strings</a></li>
					<li><a href="arrays.html">Arrays</a></li>
					
					<li><a href="containerLiterals.html">Container Literals</a></li>
					<li><a href="objects.html">Classes and Objects</a></li>
					<li><a href="constructors.html">Constructors</a></li>
					<li><a href="properties.html">Properties</a></li>
				
					<li><a href="operators.html">Operators</a></li>	
				
					<li><a href="monads.html">Monads</a></li>
					<li><a href="concurrency.html">Concurrency</a></li>
					<li><a href="erasure.html">Type Erasure</a></li>
					
					<li><a href="enhancements.html">External Enhancements</a></li>
					
				</ul>
            </li>
			<li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">More<b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="https://github.com/sergiotaborda/lense-lang">Source Code</a></li>
			    <li><a href="https://groups.google.com/forum/#!forum/lense-lang">Discussion Group</a></li>
				
				<li><a href="status.html">Roadmap &amp; Status</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
	
	<div class="corner-ribbon top-right sticky shadow turquoise"><a href="status.html">Experimentation Stage</a></div>
    
	<div class="container">
	<div class="container-fluid">
		<div class="row row-offcanvas row-offcanvas-right">
			 <div class="col-xs-12 col-sm-9 col-sm-push-3">
				<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The features explained here are still conceptual and require further study.
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="_parallelism_and_concurrency">Parallelism and Concurrency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lense chooses not to force any specific memory model or thread model because there is no guarantee it would be available in all platforms.
Instead if defines types and libraries that can be used to take advantage of the platform parallelism, if any exists.
So, concurrency is enabled,  not by language constructs, but by means of specific APIs that hide the details of parallelism and concurrency.</p>
</div>
<div class="sect2">
<h3 id="_promises_and_deference">Promises and Deference</h3>
<div class="paragraph">
<p>A <code>Promise</code> is a monad that can hold functions to be executed once a value is calculated. The promise does not define if the calculation is executed in another thread or not, but conceptually is better to work as if it where. The thread that executes the value also executes the passed functions. A promise holds a function for when the value is calculated successfully and a function for when the promise can not be calculated, i.e. the calculation ends in an exception.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="lense" class="language-lense hljs">public interface Promise&lt;T&gt; {

	public then ( onSuccess: Action&lt;T&gt;) : Promise&lt;T&gt; ;
	public catch ( onError: Action&lt;Exception&gt;) : Promise&lt;Nothing&gt;

	public map &lt;R&gt;( transformation: Function&lt;R,T&gt;): Promise&lt;R&gt; ;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Deferred</code> is a <code>Promise</code> factory that holds a private relation to the created <code>Promise</code>.<code>Deferred</code> objects also do not define the concurrency model. They are simply a factory that holds control of the internal state of the promise. Is the <code>Deferred</code> object that receives the value after the calculation is executed and triggers the <code>then</code> function, or triggers the <code>catch</code> function after an exception is detected. The calculation itself is handled by a third object.</p>
</div>
<div class="paragraph">
<p>A simple example that do not uses concurrency could be something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="lense" class="language-lense hljs">public object Calculator{

    // calculates the n-th element in the fibonacci sequence
    // n: 0	1	2	3	4	5	6	7 ...
    // f: 0	1	1	2	3	5	8	13 ...
	public fibonacci( n: Natural)  {
	        let deferred  = new Deferred.empty();

	        try {
	         	deferred.sucess(calculateRecursively (n));
	        } catch (Exception e){
	         	deferred.error(e);
	        }

	        return deferred.promisse();
	}

	private  calculateRecursively ( n:  Natural) : Natural {
		if (n &lt;= 1){
			return n;
		} else if (n &gt; 1000){
		 	// just for it to be possible to have an exception.
			throw new Exception("Cannot calculate Fibonacci for numbers greater than 1000");
		}

		return calculateRecursively (n-1) + calculateRecursively (n-2)
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implementation does not use concurrency but the client code calling the <code>fibonacci</code> function has no way of knowing this, so it has to assume the code is calculated concurrently. Later, the implementation can evolve to a concurrent one, or even a distributed version without consequences to the calling code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_executors">Executors</h3>
<div class="paragraph">
<p>An <code>Executor</code> is an object that can create another thread of execution to run a given function.
The calling code will continue to run after the executor is called, enabling concurrency.</p>
</div>
<div class="paragraph">
<p>There are two principal executors in the standard API: the <code>TimedExecutor</code> and the <code>DeferredExecutor</code>. The <code>TimedExecutor</code> enables code to be run after some time as elapsed. <code>DefferedExecutor</code> allows the code to run immediately (in another thread).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="lense" class="language-lense hljs">public object TimedExecutor {

	public runAfter&lt;T&gt;( duration : Duration, calculation : Function&lt;T&gt; ) : Promise&lt;T&gt; ;
	public runAt&lt;T&gt;( timePoint : TimePoint, calculation : Function&lt;T&gt; ): Promise&lt;T&gt; ;
	public runEvery( duration : Duration, Runnable runnable) : Void;
}

public object DeferredExecutor {

	public run&lt;T&gt;(calculation : Function&lt;T&gt; ) : Promise&lt;T&gt;;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>`Executor`s return promises that can then be combined (they are monads) to produce a result. This is equivalent to a wait/notify/join mechanism without all the fuss and without having to be specific about a thread model.</p>
</div>
<div class="paragraph">
<p>The <code>TimedExecutor</code> and <code>DeferredExecutor</code> are implemented in java using the Java Executor API. In javascript are implemented using <code>window.setTimeout</code>.
<code>Deferred</code> objects are used internally to create and control <code>Promises</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_actors_under_consideration">Actors (Under Consideration)</h3>
<div class="paragraph">
<p><code>Actor`s enable a message based communication between different threads that can be, even, distributed in one or more machines. The Actor model is similar to Java Messaging Service in Java or Web Workers in javascript, in the sense messages are exchanged back and forward but is different as to the endpoints envolved. However the technology that enables the actor to send and receive the messages depends on the `ActorEnvironment</code> used.  The environment determines how the messages are handled and several different implementations are possible. The actors exist in the scope of a specific environment. For example, in a javascript an environment based on <strong>websockets</strong> would be a natural choice. But is as not be a raw websocket implementation an other APIs like <strong>Stomp</strong> can be used. A possible code would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="lense" class="language-lense hljs">let env : ActorEnvironment = new StompActorEnvironment("http://server.side.address.com");

// register the actor with a name

env.register("myActor", new MyActor());
env.register("printActor", new PrintActor());

//sending values from outside the environment.
env.sendTo("myActor" , 4);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actor it self is a class or object that extends <code>Actor</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="lense" class="language-lense hljs">public class MyActor extends Actor {

       public onMesssage( msg: Message) {

             let n = msg.payload as Natural;

             if (exists n){
               Natural fibonacci =  calculateRecursively(n);

               this.Environment.sendTo("printActor", fibonacci);
             } else {
               this.Environment.sendTo("printActor", new Exception("No value given."));

             }
       }

}

public class PrintActor extends Actor {

       public onMesssage(msg: Message) {

			if (msg.payload is Exception){
				Console.println("The result could not be calculated because {{ msg.payload.message }}");
			} else {
				Console.println("The result is {{ msg.payload }}");
			}
       }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code will create and register two actors. The first calculates the fibonacci sequence; the second, prints the calculated value.
Actors communicate thought messages. Each actor has access to the environment is registered with and can use it to send messages to other actors.
Actors names are only significant in a given environment.</p>
</div>
<div class="paragraph">
<p>The communication is normally asynchronous whenever the <code>sendTo</code> method is called. The sent message e delivered to the actor&#8217;s message queue. The message is removed from the queue and
delivered to the <code>onMessage</code> method.</p>
</div>
</div>
<div class="sect2">
<h3 id="_passing_the_correct_data_between_actors">Passing the correct data between actors</h3>
<div class="paragraph">
<p>All data passed between actors is not shared, we do not want a shared memory model. This means the objects passed as payloads need to be serializable. If the objects are serializable, we can always serialize the object and deserialize it again to obtain a safe copy. This also is a requirement if we need to transfer the object to another machine (depending on the ActorEnvironment implementation).</p>
</div>
<div class="paragraph">
<p>For in memory environments, the environment can opt for not serializing the object for performance reasons. This is only possible if the object is immutable.
If objects are imuable there is no risk in sharing them because they cannot be changed in the first place.</p>
</div>
<div class="paragraph">
<p>For these reasons the <code>sendTo</code> method takes a <code>Serializable</code> as its message payload:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="lense" class="language-lense hljs">public  sendTo( actorId : String,  message: Serializable) : Void</code></pre>
</div>
</div>
</div>
</div>
</div>
			</div>
			<div class="col-xs-6 col-sm-3 col-sm-pull-9 sidebar-offcanvas" id="sidebar"">

<ul class="collapsible-menu">
	<li><a href="index.html">Introduction</a></i></i>
	<li><a href="status.html">Status</a></i>
	<li class="has-children">
		<a href="javascript:void(0)">Syntax and Semantics</a>
		<ul >
			<li><a href="identifiers.html">Reserved Words</a></li>
			<li><a href="variables.html">Variables and Mutability</a></li>
			<li><a href="nullability.html">Nullability</a></li>
			
			 <!--
			
			<li>Comments</li>
			<li>Generics</li>
			<li>Functions and Lambdas</li>
			
			-->
			
			<li class="has-children">
				<a href="javascript:void(0)">Fundamental Types</a>
				<ul>
					<li><a href="booleans.html">Boolean</a></li>
					<li><a href="strings.html">String</a></li>
					<li><a href="numbers.html">Number</a></li>
					<li><a href="binary.html">Binary</a></li>
					<li><a href="interval.html">Interval</a></li>
					<li><a href="iterable.html">Iterable</a></li>
					<li class="has-children"> 
						<a href="javascript:void(0)">Containers</a>
						<ul> 
							<li><a href="maybe.html">Maybe</a></li>
							<li><a href="tuples.html">Tuple</a></li>
							
							<li>Range</li>
							<li><a href="sequence.html">Sequence</a></li>
							<li>Association</li>
							
						</ul>
					</li>
				</ul>
			</li>
			<li><a href="containerLiterals.html">Container Literals</a></li>
			<li><a href="arrays.html">Arrays</a></li>
			<li class="has-children">
				<a href="javascript:void(0)">Control Statements</a>
				<ul>
					<li>Decision: if</li>
					<li>Loop : while</li>
					<li>Iteration : for</li>
					<li>Selection/Matching : switch</li>
				</ul>
			</li>
			<li class="has-children"> 
				<a href="javascript:void(0)">Types</a>
				<ul>	
					<li><a href="classes.html">Classes</a></li>
					<li><a href="objects.html">Objects</a></li>
					<li><a href="interfaces.html">Interfaces</a></li>
					<li><a href="enums.html">Enums and Sealed Types</a></li>
					<li><a href="enhancements.html">Enhancements</a></li>
					<li><a href="typeclasses.html">Type Classes</a></li>
				</ul>
			</li>
			<li class="has-children"> 
				<a href="javascript:void(0)">Type Members</a>
				<ul>
					<li><a href="constructors.html">Constructors</a></li>
					<li><a href="properties.html">Fields and Properties</a></li>
					<li><a href="indexers.html">Indexed Properties</a></li>
					<li>Methods</li>
				</ul>
			</li>
			<li><a href="casting.html">Casting</a></li>
			<li><a href="operators.html">Operator Overloading</a></li>
			
		</ul>
	</li>
	<li class="has-children">
		<a href="javascript:void(0)">Compilation</a>
		<ul>
			<li><a href="platforms.html">Platforms</a></li>
			<li><a href="erasure.html">Erasure</a></li>
		</ul>
	</li>
	<li><a href="concurrency.html">Concurrency</a>
	</li>

<ul>			</div>
		</div>
	</div>
	
	
		</div>
		<div id="push"></div>
    </div>
    
    <div id="footer">
      <div class="container">
        <p class="muted credit">Lense is an open source project </p>
      </div>
    </div>
    
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/prettify.js"></script>
    <script>
	
		$(document).ready(function() {
				$("code.language-lense").addClass("brush: lense");
				$("code.language-java").addClass("brush: java");
				$("code.language-c-sharp").addClass("brush: c-sharp");
				$("code.language-typescript").addClass("brush: typescript");
				$("code.language-dart").addClass("brush: dart");
				$("code.language-swift").addClass("brush: swift");
		});
	
    	SyntaxHighlighter.config.tagName = 'code';
		SyntaxHighlighter.defaults.toolbar = false;
		SyntaxHighlighter.all();
    
    </script>
  </body>
</html>